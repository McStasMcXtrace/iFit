<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <meta http-equiv="content-type" content="text/html;
      charset=windows-1252">
    <title>iFit: McStas</title>
  </head>
  <body>
    <ifit: changes="" title=""></ifit:>
    <h1 style="text-align: center;"><a class="mozTocH1"
        name="mozTocId294096"></a>iFit: McStas/McXtrace
      simulation/optimization<br>
    </h1>
    <h1 style="text-align: center;"><a href="http://www.mcstas.org/"><img
          alt="McStas [www.mcstas.org]" title="McStas [www.mcstas.org]"
          src="images/mcstas.png" style="border: 2px solid ; width:
          150px; height: 88px;" align="right"></a></h1>
    <h1 style="text-align: center;"> </h1>
    <ol id="mozToc">
      <!--mozToc h3 1 h4 2 h3 3 h4 4 h5 5 h6 6-->
      <li><a href="#mozTocId513250">Building an instrument model</a>
        <ol>
          <li><a href="#mozTocId500394">Specifying which monitor to use</a></li>
          <li><a href="#mozTocId619025">Requirements</a></li>
        </ol>
      </li>
      <li><a href="#mozTocId234815">Running a single simulation</a></li>
      <li><a href="#mozTocId124981">Getting instrument information and
          Displaying the instrument geometry</a></li>
      <li><a href="#mozTocId821585">Running series of simulations
          (scans)</a></li>
      <li><a href="#mozTocId690143">Optimizing instrument parameters </a></li>
      <li><a href="#mozTocId359721">Optimizing instrument parameters
          with constraints</a></li>
    </ol>
    <hr style="width: 100%; height: 2px;">
    <div style="text-align: left;">
      <div style="text-align: center;">Commands we use in this page: <span
          style="font-style: italic;">mcstas</span> (mcxtrace)<br>
      </div>
      <br>
      In this document, we demonstrate how <a href="index.html">iFit</a>/<a
        href="Optimizers.html">Optimizers</a> and <a href="iData.html">iData</a>
      can all be used transparently to simulate and optimize <a
        href="http://www.mcstas.org">McStas</a> instrument models.<br>
      <br>
      To import a McStas simulation results, just use <br>
      <pre style="margin-left: 40px;">&gt;&gt; results = <span style="color: rgb(51, 102, 255);">iData</span>(<span style="color: rgb(204, 51, 204);">'single_detector_file'</span>)<br>&gt;&gt; results = <span style="color: rgb(51, 102, 255);">iData</span>(<span style="color: rgb(204, 51, 204);">'directory'</span>)                 <span style="font-style: italic;">% import everything in the directory, including sim files (files may imported more than once)</span><br>&gt;&gt; results = <span style="color: rgb(51, 102, 255);">iData</span>(<span style="color: rgb(204, 51, 204);">'scan_directory/mcstas.<span style="font-weight: bold;">dat</span>'</span>) <span style="font-style: italic;">% for scans</span><br>&gt;&gt; results = <span style="color: rgb(51, 102, 255);">iData</span>(<span style="color: rgb(204, 51, 204);">'scan_directory/mcstas.<span style="font-weight: bold;">sim</span>'</span>) <span style="font-style: italic;">% for all files from the directory, uniquely</span>.<br></pre>
      which returns a single or an array of <span style="font-style:
        italic;">iData</span> object(s), that you can plot with e.g. <span
        style="font-style: italic;">subplot</span>.<br>
      The resulting McStas data has an additional <span
        style="font-style: italic;">Parameters</span> field which holds
      the instrument parameters used for the simulation.<br>
      <pre style="margin-left: 40px;">&gt;&gt; results(1).Parameters<br></pre>
      <h3><a class="mozTocH3" name="mozTocId513250"></a>Building an
        instrument model</h3>
      <p>The syntax for building a McCode (McStas or McXtrace)
        instrument model is:<br>
      </p>
      <pre style="margin-left: 40px;">&gt;&gt; model = <span style="color: rgb(51, 102, 255);">mccode</span>(<span style="color: rgb(204, 51, 204);">'instrument'</span>);	<i>% uses the given instrument file (*.instr)</i><br>&gt;&gt; model = <span style="color: rgb(51, 102, 255);">mccode</span>(<span style="color: rgb(204, 51, 204);">'gui'</span>);		<i>% lists all available instruments to select one</i><br>&gt;&gt; model = <span style="color: rgb(51, 102, 255);">mccode</span>(<span style="color: rgb(204, 51, 204);">''</span>);			<i>% pop-up a file selector to select an *.instr file</i><br>&gt;&gt; model = <span style="color: rgb(51, 102, 255);">mccode</span>(<span style="color: rgb(204, 51, 204);">'defaults'</span>);		<i>% uses the templateDIFF instrument as example <br></i></pre>
      which compile the instrument, and create an <a
        href="file:///home/farhi/dev/iFit/Docs/iFunc.html">iFunc</a>
      model. <br>
      When the instrument is not found in the current directory, it is
      searched in the McStas library (may be specified with the MCSTAS
      and MCXTRACE environment variables), and eventually copied
      locally, which triggers its compilation.<br>
      <br>
      In addition, it is possible to select an instrument from the
      McStas installation with:<br>
      <br>
      You may even assemble these models as iFunc arrays to iteratively
      perform series of simulations, or use arithmetic operations to
      combine models (see the <a href="iFunc.html#mozTocId443357">iFunc</a>
      documentation).<br>
      <br>
      It is also possible to finely tune the instrument configuration
      using standard McStas/McXtrace options with the syntax:<br>
      <blockquote>
        <pre>&gt;&gt;  <span style="color: rgb(51, 102, 255);">mccode</span>(<span style="color: rgb(204, 51, 204);">'instrument'</span>, options)</pre>
      </blockquote>
      and the following options:<br>
      <table width="100%" border="1" cellpadding="2" cellspacing="2">
        <tbody>
          <tr>
            <td valign="top"><b>options.dir</b></td>
            <td valign="top"> directory where to store results, or set
              automatically (string) ;<br>
              the last simulation files are stored therein 'sim'.</td>
          </tr>
          <tr>
            <td valign="top"><b>options.ncount</b></td>
            <td valign="top">number of neutron events per iteration,
              e.g. 1e6 (double).</td>
          </tr>
          <tr>
            <td valign="top"><b> options.mpi</b><b><br>
              </b> </td>
            <td valign="top">number of processors/cores to use with MPI
              on localhost or cluster (integer) ;<br>
              when MPI is available, and mpi options is not given, all
              cores are then used. Use options.mpi=1 for a serial
              calculation.<br>
            </td>
          </tr>
          <tr>
            <td valign="top"><b> options.machines</b></td>
            <td valign="top">file name containing the list of
              machines/nodes to use (string), as often found in cluster
              job schedulers.<br>
            </td>
          </tr>
          <tr>
            <td valign="top"><b>options.seed</b></td>
            <td valign="top">random number seed to use for each
              iteration (double)</td>
          </tr>
          <tr>
            <td valign="top"><b>options.gravitation</b></td>
            <td valign="top">0 or 1 to set gravitation handling in
              neutron propagation (boolean)</td>
          </tr>
          <tr>
            <td valign="top"><b>options.monitor</b></td>
            <td valign="top">a <i>single</i> monitor name to read, or
              left empty for the last (string). The whole monitors are
              available as iData objects in the <i>model.UserData.monitors</i>
              field.<br>
            </td>
          </tr>
          <tr>
            <td valign="top"><b>options.mpirun</b></td>
            <td valign="top">set the executable path to 'mpirun', or
              automatically found when not set.<br>
            </td>
          </tr>
          <tr>
            <td valign="top"><b>options.compile</b></td>
            <td valign="top">0 or 1 to force re-compilation of the
              executable. Try that first if you can not create/use the
              object (an old executable may be used).</td>
          </tr>
        </tbody>
      </table>
      &nbsp;<br>
      The options can be given as a structure or as a string, e.g. <font
        color="#cc33cc">'ncount=1e6; compile=1'</font>.<br>
      &nbsp;<br>
      The scalar instrument parameters of type 'double' are used as
      model parameters. <br>
      Other parameters (e.g. of type string and int) are stored as a
      structure in:<br>
      <ul>
        <li>model.UserData.Parameters_Constant</li>
      </ul>
      The options <i>ncount, seed, gravitation, monitor</i> can be
      changed after the model creation in the UserData area of the
      object e.g.:<br>
      <ul>
        <li>model.UserData.options.gravitation=1;</li>
        <li>model.UserData.options.monitor=<font color="#cc33cc">''</font>;</li>
      </ul>
      <h4><a class="mozTocH4" name="mozTocId500394"></a><i><b>Specifying
            which monitor to use</b></i></h4>
      The default behaviour is to leave <i>options.monitor</i> left
      unset at the model creation, so that all monitors are read when
      simulating instruments. The last monitor is then used as model
      value. This provides maximum information, but the processing
      overhead time is increased due to more data handling compared to a
      single/restricted monitor name selection.<br>
      <ul>
        <li>model=<font color="#3366ff">mccode</font>(<font
            color="#cc33cc">'templateDIFF'</font>);</li>
      </ul>
      In order to improve the computational efficiency, it is advised to
      specify which files have to be imported to define the model value
      by giving a file pattern. This can be done either when building
      the model:<br>
      <ul>
        <li>model=<font color="#3366ff">mccode</font>(<font
            color="#cc33cc">'templateDIFF'</font>,<font color="#cc33cc">'monitor=Diff_BananaPSD'</font>);</li>
      </ul>
      or afterwards:<br>
      <ul>
        <li>model=<font color="#3366ff">mccode</font>(<font
            color="#cc33cc">'templateDIFF'</font>);</li>
        <li>model.UserData.options.monitor=<font color="#cc33cc">'</font><font
            color="#cc33cc"><font color="#cc33cc">Diff_Banana</font>'</font></li>
      </ul>
      which in both cases will select monitor files which <i>start</i>
      with the given string ( <font color="#cc33cc">'Diff_Banana*' </font>).
      In case the selection brings multiple files, the last one is used.
      When the monitor name selection does not match any file, or is
      given as empty, all monitors are imported, and the last one in the
      list is used.<br>
      <br>
      All selected monitors are imported as <a href="Fit.html">iData</a>
      object(s), in:<br>
      <ul>
        <li>model.UserData.monitors</li>
      </ul>
      In practice, you will often either not specify the 'monitors' at
      the model creation to leave the system select the last one, or
      indicate a specific monitor name of your choice.<br>
      <h4><a class="mozTocH4" name="mozTocId619025"></a><i><b>Requirements</b></i></h4>
      As iFit contains powerful import routines, that support McStas
      data files, it is straight forward to launch a McStas instrument
      simulation from Matlab and get back the simulation results. To do
      so, you will obviously need to have <span style="font-style:
        italic;">iFit</span> installed (refer to the <a
        href="file:///home/farhi/dev/iFit/Docs/Install.html">Install</a>
      page), as well as <span style="font-style: italic;">McStas</span>
      (refer to the <a href="http://www.mcstas.org">McStas web site</a>)
      or <a href="http://mcxtrace.org/">McXtrace</a>. When used with
      the standalone version, no Matlab license is needed.<br>
      <h3><a class="mozTocH3" name="mozTocId234815"></a>Running a single
        simulation</h3>
      The model value is corresponds with the 'options.monitor'
      selected, i.e. the last one, or a specific name pattern. This
      selection can be changed any time without rebuilding the model
      (see <a href="mozTocId500394">above</a>).<br>
      <br>
      The instrument can be evaluated with given parameters and
      optionally axes:<br>
      <pre style="margin-left: 40px;">&gt;&gt; results = <font color="#3366ff">feval</font>(model, parameters);		<i>% return the monitor as an array using guessed axes</i><br>&gt;&gt; results = <font color="#3366ff">feval</font>(model, parameters, x,y,...);	<i>% return the monitor as an array</i><i>, using specified axes</i><br>&gt;&gt; results = <font color="#3366ff">feval</font>(model, parameters, nan);	<i>% return the raw monitor as an array</i><br></pre>
      but it may be more convenient to manipulate the model value as
      iData objects:<br>
      <pre style="margin-left: 40px;">&gt;&gt; result = <font color="#3366ff">iData</font>(model, parameters);		<i>% return monitor interpolated onto guessed axes<br></i>&gt;&gt; result = <font color="#3366ff">iData</font>(model, parameters, nan);	<i>% return raw monitor as an iData object</i><br>&gt;&gt; result = <font color="#3366ff">iData</font>(model, parameters, x,y,...);	<i>% return monitor interpolated onto axes x,y,...</i><br>&gt;&gt; <font color="#3366ff">plot</font>(result);<br>&gt;&gt; <font color="#3366ff">plot</font>(model.UserData.monitors)</pre>
      where <span style="font-style: italic;">parameters</span> is a
      structure, or string, or vector that holds parameter names and
      values, e.g.<br>
      <div style="margin-left: 40px;">
        <ul>
          <li>model=<font color="#3366ff">mccode</font>(<font
              color="#cc33cc">'templateDIFF'</font>);</li>
          <li> parameters.RV=1;</li>
          <li> parameters.lambda=2.36;</li>
          <li> <font color="#3366ff"><font color="#000000">value = </font>iData</font>(model,
            parameters);</li>
        </ul>
      </div>
      <div style="text-align: left;">or in a more compact way, giving
        parameters as a single string with members assigned with '=' and
        separated with the ';' character. <br>
        In the following example, we plot the model value, and then all
        the available monitors in <i>model.UserData.monitors</i><br>
        <ul>
          <li>model=<font color="#3366ff">mccode</font>(<font
              color="#cc33cc">'templateDIFF'</font>);</li>
          <li> <font color="#3366ff"><font color="#000000">value = </font>iData</font>(model,
            <font color="#cc33cc">'RV=1; lambda=2.36'</font>, nan)</li>
        </ul>
        <blockquote>
          <pre>value =&nbsp; iData (methods,doc,plot,plot(log),values,more...) 2D object:<br>&nbsp;&nbsp;&nbsp; [Tag] [Dimension]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Title] [Last command]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Label/DisplayName]</pre>
          <pre>&nbsp; iD61442&nbsp;&nbsp;&nbsp; [51 170]&nbsp;&nbsp; 'templateDIFF.instr McCode [... "signal"' iD61442=setalias(iD6... templateDI/templateDI...</pre>
        </blockquote>
        <ul>
          <li><font color="#3366ff">plot</font>(value, <font
              color="#cc33cc">'view2'</font>)</li>
          <li>model.UserData.monitors<br>
          </li>
        </ul>
        <blockquote>
          <pre>model.UserData.monitors =&nbsp; array [5&nbsp; 1] iData (methods,doc,plot,plot(log),values,more...) object:<br><br>Index&nbsp;&nbsp;&nbsp;&nbsp; [Tag] [Dimension]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Title] [Last command]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [Label/DisplayName]<br>&nbsp;&nbsp;&nbsp; 1&nbsp;&nbsp; iD61449&nbsp;&nbsp;&nbsp;&nbsp; [40 40] 'mccode.sim McCode sim file ... "Data ..."' iD61449=load(iData,'... Diff_Mono_XY<br>&nbsp;&nbsp;&nbsp; 2&nbsp;&nbsp; iD61457&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [40 1] 'mccode.sim McCode sim file ... "Inten..."' iD61457=load(iData,'... Diff_Mono_Lambda<br>&nbsp;&nbsp;&nbsp; 3&nbsp;&nbsp; iD61459&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; [40 1] 'mccode.sim McCode sim file ... "Inten..."' iD61459=load(iData,'... Diff_Sample_Lambda<br>&nbsp;&nbsp;&nbsp; 4&nbsp;&nbsp; iD61461&nbsp;&nbsp;&nbsp;&nbsp; [340 1] 'mccode.sim McCode sim file ... "Inten..."' iD61461=load(iData,'... Diff_BananaTheta<br>&nbsp;&nbsp;&nbsp; 5&nbsp;&nbsp; iD61463&nbsp;&nbsp;&nbsp; [25 170] 'mccode.sim McCode sim file ... "Data ..."' iD61463=load(iData,'... Diff_BananaPSD</pre>
        </blockquote>
        <ul>
          <li><font color="#3366ff">plot</font>(model.UserData.monitors)</li>
        </ul>
        You can equally set the non numerical scalar parameters (e.g.
        strings and integers):<br>
        <blockquote>model.UserData.Parameters_Constant.powder=<span
            style="color: rgb(204, 51, 204);">'Na2Ca3Al2F14.laz'</span><br>
          <span style="color: rgb(204, 51, 204);"></span></blockquote>
        <span style="color: rgb(204, 51, 204);"></span>The unspecified
        instrument parameters are used with their default values (when
        defined).<br>
        <br>
        The model value, and the raw monitors in
        model.UserData.monitors, in the form of an iData objects have an
        additional <span style="font-style: italic;">Parameters</span>
        field which holds the instrument parameters used for the
        simulation.<br>
        <pre style="margin-left: 40px;">&gt;&gt; value.Parameters</pre>
        Usual data analysis (display, mathematics, fit, export) can be
        performed (refer to the <a
          href="file:///home/farhi/dev/iFit/Docs/index.html">iFit</a>
        and <a href="file:///home/farhi/dev/iFit/Docs/iData.html">iData</a>
        documentation). <br>
        <h3><a class="mozTocH3" name="mozTocId124981"></a>Getting
          instrument information and Displaying the instrument geometry</h3>
        To display the instrument geometry, use the syntax:<br>
        <pre style="margin-left: 40px;">&gt;&gt; <span style="color: rgb(51, 102, 255);">mccode_display</span>(model<span style="color: rgb(204, 51, 204);"></span>);</pre>
        which open a geometrical representation of the instrument. The
        current model parameters are used. It can be given as well a set
        of parameter values:<br>
        <pre style="margin-left: 40px;">&gt;&gt; <span style="color: rgb(51, 102, 255);">mccode_display</span>(model<span style="color: rgb(204, 51, 204);"></span>, parameters);</pre>
        An empty parameter argument requests to use the current value.
        In addition, this routine returns the list of components, and
        can be given more options (3rd argument), as <font
          color="#cc33cc">'html'</font>,<font color="#cc33cc">'png'</font>,
        and <font color="#cc33cc">'x3d'</font>.<br>
        <pre style="margin-left: 40px;">&gt;&gt; <span style="color: rgb(51, 102, 255);">mccode_display</span>(model<span style="color: rgb(204, 51, 204);"></span>, [], <font color="#cc33cc">'html png x3d'</font>);</pre>
        to generate hardcopy files and geometry rendering.<br>
        <br>
        In order to get information about the instrument, especially its
        input parameters, you can access the model.UserData area:<br>
        <pre>&gt;&gt; model.UserData<br><br>ans = <br><br>        instrument_source: [1x7011 char]<br>    instrument_executable: [1299344x1 double]<br>           instrument_exe: 'templateDIFF.out'<br>          instrument_info: [1x960 char]<br>                  options: [1x1 struct]<br>               Parameters: [1x1 struct]<br>      Parameters_Constant: [1x1 struct]<br>                 monitors: [5x1 iData]<br></pre>
        and especially the instrument_info and instrument_source, which
        you can edit with e.g:<br>
        <ul>
          <li><font color="#3366ff">disp</font>(model.UserData.instrument_info)</li>
        </ul>
        or even in a separate window:<br>
        <blockquote>
          <pre>&gt;&gt; <font color="#3366ff">TextEdit</font>(model.UserData.instrument_source)<br>&gt;&gt; <font color="#3366ff">TextEdit</font>(model.UserData.instrument_info)</pre>
        </blockquote>
      </div>
      <h3><a class="mozTocH3" name="mozTocId821585"></a>Running series
        of simulations (scans)</h3>
      You may scan the model parameters when they are assigned as
      vector.<br>
      <ul>
        <li>model=<font color="#3366ff">mccode</font>(<font
            color="#cc33cc">'templateDIFF'</font>);</li>
        <li>parameters.RV = 0.5:.05:1.5;</li>
        <li>scan = <font color="#3366ff">iData</font>(model,
          parameters);</li>
      </ul>
      A more compact way can be used, using explicit scan values:<br>
      <ul>
        <li>model=<font color="#3366ff">mccode</font>(<font
            color="#cc33cc">'templateDIFF'</font>);</li>
        <li>scan = <font color="#3366ff">iData</font>(model, <font
            color="#cc33cc">'RV=[0.5 1 1.5]'</font>);</li>
      </ul>
      You may also scan the non numerical parameters with e.g. for the
      'powder' string parameter:<br>
      <ul>
        <li>r=[];</li>
        <li>for vector = {<span style="color: rgb(204, 51, 204);">'Na2Ca3Al2F14.laz'</span>,<span
            style="color: rgb(204, 51, 204);">'Al.laz'</span>,<span
            style="color: rgb(204, 51, 204);">'Ge.laz'</span>};
          model.UserData.Parameters_Constant.powder = vector{1}; r = [ r
          iData(model) ]; end</li>
      </ul>
      <br>
      <br>
      &nbsp;It is very simple to perform parameter scans, even in
      multi-dimensional spaces. For this, the parameter values just need
      to be vectors of numeric or vector cells, such as<br>
      <ul>
        <li>parameters.RV={0.5 1 1.5};</li>
        <li>parameters.L2= 2:0.5:4;</li>
        <li>parameters.L3= 1.3;</li>
      </ul>
      Scans with string parameters are also possible, such as with<br>
      <ul>
        <li>parameters.Powder={<span style="color: rgb(204, 51, 204);">'Na2Ca3Al2F14.laz','Al.laz','Cd.laz'</span>};</li>
      </ul>
      and then executes for instance:<br>
      <div style="margin-left: 40px;">
        <pre>&gt;&gt; [integral,monitors]=<span style="color: rgb(51, 102, 255);">mcstas</span>(<span style="color: rgb(204, 51, 204);">'templateDIFF'</span>, parameters, <span style="color: rgb(51, 102, 255);">struct</span>(<span style="color: rgb(204, 51, 204);">'ncount'</span>,1e4));<br></pre>
      </div>
      A live display of the on-going scan is shown when specifying <span
        style="font-weight: bold;">OutputFcn</span>=<span style="color:
        rgb(204, 51, 204);">'fminplot' </span>in the last <span
        style="font-weight: bold;">options</span> argument (struct).<br>
      <br>
      The <span style="font-style: italic;">integral</span> argument
      returned is an <a href="iData.html">iData</a> object containing
      the integral of monitors as a function of the scanned parameters.
      It can be directly plotted with e.g. <br>
      <div style="margin-left: 40px;">
        <pre>&gt;&gt; <span style="color: rgb(51, 102, 255);">plot</span>(integral);     <span style="font-style: italic;">% simple plot, or median surface for multidimensional scans</span><br>&gt;&gt; <span style="color: rgb(51, 102, 255);">scatter3</span>(integral); <span style="font-style: italic;">% coloured points (possibly in 2D,3D)</span><br>&gt;&gt; <span style="color: rgb(51, 102, 255);">plot3</span>(integral);    <span style="font-style: italic;">% coloured lines in 2D, or volume for multidimensional scans</span><br>&gt;&gt; <span style="color: rgb(51, 102, 255);">slice</span>(integral);    <span style="font-style: italic;">% only for 3D, use slice-o-matic for volume inspection</span><br></pre>
      </div>
      <a href="images/iFit_McStas_scan2D_integral.png"><img title="iFit:
          MsCtas scan: ploting the integral monitor value"
          src="images/iFit_McStas_scan2D_integral.png" alt="iFit: MsCtas
          scan: ploting the integral monitor value" style="border: 0px
          solid ; width: 200px; height: 177px;" align="right"></a>The <span
        style="font-style: italic;">monitors</span> argument returned is
      an array containing individual scan monitors. You may extract and
      catenate a selection (slices) or it by e.g. the <span
        style="font-style: italic; font-weight: bold;">iData/cat</span>
      method.<br>
      <br>
      In the following example, we launch a quick 2D scan:<br>
      <pre style="margin-left: 40px;">&gt;&gt; [p,m]=<span style="color: rgb(51, 102, 255);">mcstas</span>(<span style="color: rgb(204, 51, 204);">'templateDIFF'</span>, <span style="color: rgb(51, 102, 255);">struct</span>(<span style="color: rgb(204, 51, 204);">'RV'</span>,[0.7 0.9 1.2],<span style="color: rgb(204, 51, 204);">'L2'</span>,[1 1.3 1.5]),<span style="color: rgb(51, 102, 255);">struct</span>(<span style="color: rgb(204, 51, 204);">'ncount'</span>,1e4));<br></pre>
      Then we may plot, as a 2D surface, the integral value for the last
      (5th) monitor:<br>
      <pre style="margin-left: 40px;">&gt;&gt; <span style="color: rgb(51, 102, 255);">plot</span>(p(:,:,5));<br></pre>
      <a href="images/iFit_McStas_Monitor_scan.png"><img title="iFit:
          McStas: evolution of a monitor"
          src="images/iFit_McStas_Monitor_scan.png" alt="iFit: McStas:
          evolution of a monitor" style="border: 0px solid ; width:
          200px; height: 177px;" align="right"></a>You may look at the
      instrument parameters used for the scans, e.g.<br>
      <pre style="margin-left: 40px;">&gt;&gt; <span style="color: rgb(51, 102, 255);">get</span>(m,<span style="color: rgb(204, 51, 204);">'RV'</span>)<br></pre>
      which are also available in the <span style="font-style: italic;">Parameters</span>
      field of the objects.<br>
      Let's finally look at the evolution of the 4-th monitor, which is
      a 1D diffractogram, along an 'RV' parameter scan:<br>
      <pre style="margin-left: 40px;">&gt;&gt; a = <span style="color: rgb(51, 102, 255);">squeeze</span>(m(2,:,:));  <span style="font-style: italic;">         % extract an 'RV' line, with L2=1.3</span><br>&gt;&gt; b = a(:,4);   <span style="font-style: italic;">                   % get 4th monitor on this line</span><br>&gt;&gt; setaxis(b,2,<span style="color: rgb(204, 51, 204);">'RV'</span>);               % define a new axis along the line RV<br>&gt;&gt; c = <span style="color: rgb(51, 102, 255);">cat</span>(2, b);   <span style="font-style: italic;">                % assemble into a single iData object</span><br>&gt;&gt; <span style="color: rgb(51, 102, 255);">plot</span>(c,<span style="color: rgb(204, 51, 204);">'tight interp'</span>);          <span style="font-style: italic;">% plot</span><br></pre>
      This methodology also works with 2D monitors assembled along, e.g.
      a scan line, which creates a 3D volume to explore with <span
        style="font-style: italic; font-weight: bold;">slice, </span>or
      <span style="font-style: italic; font-weight: bold;">plot</span>&nbsp;







      or <span style="font-weight: bold; font-style: italic;">plot3</span>.
      <br>
      <br>
      <div style="margin-left: 40px;"> </div>
      <span style="color: rgb(255, 0, 0); font-weight: bold;">Warning: </span>Beware
of
the
number
of







      iterations required to scan large dimensionality spaces. In
      practice you should avoid spaces above 2 or 3 scanned parameters.
      Exceeding this will undoubtedly require very long computation
      times, and large memory storage.<br>
      <h3><a class="mozTocH3" name="mozTocId690143"></a>Optimizing
        instrument parameters<br>
      </h3>
      The optimization of instrument parameters is performed as simply
      as a single simulation, just by e.g. setting <span
        style="font-style: italic;">options.mode</span> to <span
        style="color: rgb(204, 51, 204);">'optimize'</span>. <span
        style="font-style: italic;"><br>
      </span>
      <pre style="margin-left: 40px;">&gt;&gt; [solution, monitors] = <span style="color: rgb(51, 102, 255);">mcstas</span>(<span style="color: rgb(204, 51, 204);">'instrument'</span>, parameters, options);</pre>
      The parameters, as a named structure, are initiated to their
      starting value, from which the optimization proceeds.<span
        style="font-style: italic;"> Only numerical</span> parameters
      can be optimized. Also, it is <span style="color: rgb(255, 0,
        0);">highly encouraged to use bounded parameters</span> (that is
      define constraints, see <a href="#mozTocId359721">below</a>),
      else the optimizer can get lost, produce un-meaningful results, or
      return <span style="font-style: italic;">NaN</span> parameter
      values.<br>
      <br>
      More specifically, the <span style="font-style: italic;">options</span>
      structure may contain, in addition to the optimization mode, the
      following members:<br>
      <ul>
        <li><span style="font-weight: bold;">options.type</span>:&nbsp;&nbsp;








          <span style="color: rgb(204, 51, 204);">'minimize'</span> or<span
            style="color: rgb(204, 51, 204);"> 'maximize'</span>, which
          is the default (string)</li>
        <li><span style="font-weight: bold;">options.monitors</span>:&nbsp;
cell







          string of monitor file names, or empty for all (cellstr). This
          option actually improves dramatically the file importation by
          selecting only the relevant files.<br>
        </li>
        <li><span style="font-weight: bold;">options.optimizer</span>:
          function name of the optimizer to use, default is <span
            style="font-style: italic;">fminpso</span> (string or
          function handle). See <a href="Optimizers.html">Optimizers</a>.<br>
        </li>
        <li><span style="font-weight: bold;">options.mode</span>:&nbsp;&nbsp;
should







          be <span style="color: rgb(204, 51, 204);">'optimize'</span>.
          This is automatically set whenever an 'optimization'
          configuration field is set, such as <span style="font-style:
            italic;">monitors, optimizer, TolFun, ...</span><span
            style="color: rgb(204, 51, 204);"> </span></li>
      </ul>
      as well as any other optimizer configuration fields such as<br>
      <ul>
        <li><span style="font-weight: bold;">options.TolFun</span> =<span
            style="color: rgb(204, 51, 204);">'1%'</span>;&nbsp;<span
            style="font-style: italic;"> % stop when criteria changes
            are smaller that 1%,<span style="font-weight: bold;"> this
              is the default</span><br>
          </span></li>
        <li><span style="font-weight: bold;">options.TolX</span> =<span
            style="color: rgb(204, 51, 204);">'0.1%';</span>
          &nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <span style="font-style:
            italic;">% stop when parameter changes are smaller that 0.1%</span></li>
        <li><span style="font-weight: bold;">options.Display</span>=<span
            style="color: rgb(204, 51, 204);">'final';</span></li>
        <li><span style="color: rgb(204, 51, 204);"><span style="color:
              rgb(0, 0, 0);"><span style="font-weight: bold;">options.OutputFcn</span>=</span>'fminplot';










          </span>% plots the criteria and parameters evolution during
          the optimization. <span style="font-style: italic;
            font-weight: bold;">This is the default</span>. Set to <span
            style="color: rgb(204, 51, 204);">''</span> to override this
          choice. A view of the monitors used as criteria is also
          displayed.<br>
        </li>
      </ul>
    </div>
    The default optimizer configuration is used when not specified (see
    the <a href="Optimizers.html">Optimizers</a> page for more
    details), as well as the interactive plotting and verbose
    information during the optimization.<br>
    <br>
    The optimization returns the best parameter guess, as well as the
    monitor value for this solution.<br>
    In addition, similarly with other iFit <a href="Optimizers.html">optimization







      methods</a>, the optimizer final status and optional returned
    information can be obtained with e.g. <br>
    <pre style="margin-left: 40px;">&gt;&gt; [parameters, monitors, <span style="color: rgb(255, 0, 0);">status, output</span>]=<span style="color: rgb(51, 102, 255);">mcstas</span>(<span style="color: rgb(204, 51, 204);">'templateDIFF'</span>,<span style="color: rgb(51, 102, 255);">struct</span>(<span style="color: rgb(204, 51, 204);">'RV'</span>,1), ...<br>      <span style="color: rgb(51, 102, 255);">struct</span>(<span style="color: rgb(204, 51, 204);"></span><span style="color: rgb(204, 51, 204);">'monitors'</span>,<span style="color: rgb(204, 51, 204);">'Banana'</span>,<span style="color: rgb(204, 51, 204);">'mode','optimize','optimizer','fminimfil'</span>));</pre>
    where <span style="font-style: italic;">output</span> stores most
    of the optimization process data, including uncertainty on the best
    parameter values, <span style="font-style: italic;">output.parsHistoryUncertainty






    </span>and<span style="font-style: italic;"> </span><span
      style="font-style: italic;">output.parsHessianUncertainty</span>.<br>
    <br>
    <a href="images/iFit_McStas_optimize.png"><img
        src="images/iFit_McStas_optimize.png" alt="iFit: McStas wrapper:
        dynamic optimization evolution" style="border: 0px solid ;
        width: 200px; height: 190px;" align="right"></a>In the following
    example, we search for an optimal monochromator curvature (parameter
    <span style="font-style: italic;">RV</span>) on the <span
      style="font-style: italic;">templateDIFF</span> instrument model,
    in order to maximize the <span style="font-style: italic;">Banana</span>
    monitors (as<span style="font-style: italic;"> 'monitors' </span>option):<br>
    <pre style="margin-left: 40px;">&gt;&gt; [parameters, monitors]=<span style="color: rgb(51, 102, 255);">mcstas</span>(<span style="color: rgb(204, 51, 204);">'templateDIFF'</span>,<span style="color: rgb(51, 102, 255);">struct</span>(<span style="color: rgb(204, 51, 204);">'RV'</span>,1), ...<br>      <span style="color: rgb(51, 102, 255);">struct</span>(<span style="color: rgb(204, 51, 204);"></span><span style="color: rgb(204, 51, 204);">'monitors'</span>,<span style="color: rgb(204, 51, 204);">'Banana'</span>,<span style="color: rgb(204, 51, 204);">'optimizer','fminimfil'</span>));<br>parameters =<br>     RV: 0.75<br></pre>
    The monitors to use as optimization criteria (<span
      style="font-style: italic;">options.monitors</span>) can be part
    of a more complex expression, which still must start with the file
    name of the monitor, and then refer to itself with the<span
      style="font-style: italic;"> 'this' </span>variable (which is an
    <a href="iData.html">iData</a> object), such as in the following
    example where we define the criteria as <span style="font-style:
      italic;">Amplitude/width²</span> (for a single peak)<br>
    <pre style="margin-left: 40px;"><span style="color: rgb(0, 0, 0);">options.monitors=</span><span style="color: rgb(204, 51, 204);">'Banana; this=max(this)/std(this)^2'<br></span><span style="color: rgb(0, 0, 0);">options.monitors=</span><span style="color: rgb(204, 51, 204);">'Banana/std(this)^4'</span><br></pre>
    When the monitor filter selects more than one data set (e.g. more
    than one file match the monitor selection name), <span
      style="font-style: italic;">'this'</span> is an <a
      href="iData.html">iData</a> array. Specifying a monitor list
    highly speeds-up the importation of files after each iteration.<br>
    For simpler definitions, the <span style="font-style: italic;">options</span>
    can be given as a string, similarly to the starting parameters:<br>
    <pre style="margin-left: 40px;"><span style="color: rgb(51, 102, 255);">mcstas</span>(<span style="color: rgb(204, 51, 204);">'templateDIFF'</span>,<span style="color: rgb(51, 102, 255);"></span><span style="color: rgb(204, 51, 204);">'RV=[1 3]'</span>, <span style="color: rgb(51, 102, 255);"></span><span style="color: rgb(204, 51, 204);"></span><span style="color: rgb(204, 51, 204);">'monitors=</span><span style="color: rgb(204, 51, 204);">Banana; </span><span style="color: rgb(204, 51, 204);">mode=optimize;'</span>)</pre>
    During the optimization, a dynamic plot of the criteria evolution
    (the sum of the <span style="font-style: italic;">Banana</span>
    detector counts) and the parameters evolution is shown. The number
    of optimized parameters can be large, and only the first 3 ones will
    be shown on the dynamic plot. <br>
    The <span style="font-style: italic;">default stopping condition</span>
    is met when the integral monitor change is lower than 1%.<br>
    <br>
    To abort the optimization, just <span style="font-weight: bold;">close







      the optimization plot</span> window. The actual end occurs after a
    few more iterations.<br>
    <br>
    <span style="color: rgb(255, 0, 0); font-weight: bold;">Warning: </span>as







    <a href="http://www.mcstas.org">McStas</a> uses a Monte-Carlo
    technique (which means 'random'), the criteria is a noisy function.
    The stop conditions must then usually be quite relaxed for the
    optimization to end, or the number of <span style="font-style:
      italic;">ncounts</span> must be large enough to minimize the
    statistical uncertainty. TolFun=<span style="color: rgb(204, 51,
      204);">'0.1%</span>' and TolX=<span style="color: rgb(204, 51,
      204);">'0.1%'</span> are fair choices. Also, we recommend to
    constrain parameter ranges (<span style="color: rgb(255, 0, 0);">see
      <a href="#mozTocId359721">below</a></span>). Also, increasing the<span
      style="font-style: italic;"> 'ncount' </span>(which is 1e5 by
    default) may help the optimizer to search in a noisy criteria
    landscape.<br>
    <h3><a class="mozTocH3" name="mozTocId359721"></a>Optimizing
      instrument parameters with constraints</h3>
    It is quite usual the restrict the parameters search to specified
    ranges, and to fix some of the parameters. We have seen that an
    optimization can be initiated by defining the starting parameter
    value with e.g. <span style="font-style: italic;">parameters.RV=1</span>,
    together with e.g. <span style="font-style: italic;">options.mode=</span><span
      style="color: rgb(204, 51, 204);">'optimize'</span>.<br>
    <br>
    To fix a parameter value during the optimization, use a string
    parameter value, such as :<br>
    <ul>
      <li>parameters.L2 = <span style="color: rgb(204, 51, 204);">'0.85'</span>;
        <span style="font-style: italic;">% fix the L2 parameter to 0.85
          during optimization</span><br>
      </li>
    </ul>
    To restrict a parameter search to a given range, set its minimum and
    maximum values :<br>
    <ul>
      <li>parameters.RV = [ 0.7 1.2 ]; <span style="font-style:
          italic;">% the initial RV value will be used as the mean,
          0.95, and will be kept in between 0.7 and 1.2.</span><br>
      </li>
    </ul>
    If you wish to restrict tne search range as well as define the
    starting parameter value, use a 3 element vector <span
      style="font-style: italic;">[min start max ]</span>:<br>
    <ul>
      <li>parameters.RV = [ 0.7 0.8 1.2 ]; <span style="font-style:
          italic;">% the initial RV value will be 0.8</span></li>
    </ul>
    We strongly <span style="font-weight: bold;">recommend</span> to
    limit the parameter search within boundaries during optimizations.<br>
    <pre style="margin-left: 40px;">&gt;&gt; [parameters, monitors]=<span style="color: rgb(51, 102, 255);">mcstas</span>(<span style="color: rgb(204, 51, 204);">'templateDIFF'</span>,<span style="color: rgb(51, 102, 255);">struct</span>(<span style="color: rgb(204, 51, 204);">'RV'</span>,[0.7 0.8 1.2]), ...<br>      <span style="color: rgb(51, 102, 255);">struct</span>(<span style="color: rgb(204, 51, 204);"></span><span style="color: rgb(204, 51, 204);">'monitors'</span>,<span style="color: rgb(204, 51, 204);">'Banana'</span>,<span style="color: rgb(204, 51, 204);">'mode','optimize','mpi<span style="color: rgb(0, 0, 0);">',4,</span>'compile'<span style="color: rgb(0, 0, 0);">,1</span></span>));</pre>
    <br>
    <hr style="width: 100%; height: 2px;">
    <div style="text-align: center;">
      <div style="text-align: center;"><span style="font-style: italic;">E.
Farhi







          - iFit/McStas - </span><span style="font-style: italic;">
          $Date$ $Revision$ </span><span style="font-style: italic;"> </span>-
        back to <a href="index.html">Main iFit Page </a><a
          href="http://www.ill.eu/"><img title="ILL, Grenoble, France
            &lt;www.ill.eu&gt;" src="images/ILL-web-jpeg.jpg" alt="ILL,
            Grenoble, France &lt;www.ill.eu&gt;" style="border: 0px
            solid ; width: 53px; height: 50px;" align="right"></a> </div>
    </div>
  </body>
</html>
