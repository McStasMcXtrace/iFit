<!DOCTYPE html PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
  <head>
    <title>iFit: iFunc model definition</title>
    <meta http-equiv="content-type" content="text/html;
      charset=windows-1252">
  </head>
  <body>
    <h1 style="text-align: center;">iFit: iFunc object description</h1>
    <ul id="mozToc">
      <!--mozToc h3 1 h4 2 h3 3 h4 4 h5 5 h6 6-->
      <li><a href="#mozTocId466436">Creating and inquiring iFunc models
          (iFunc, get, plot, subplot) </a>
        <ul>
          <li><a href="#mozTocId721898">Model from a tabulated data set</a></li>
          <li><a href="#mozTocId780038"> Accessing or modifying
              parameter values</a></li>
          <li><a href="#mozTocId354273"> Defining a new model</a></li>
        </ul>
      </li>
      <li><a href="#mozTocId966568"> Evaluating a model with parameter
          values and axes</a></li>
      <li><a href="#mozTocId579374">Setting and removing constraints on
          models</a></li>
      <li><a href="#mozTocId2492">Saving objects for further re-use:
          save, saveas, load</a></li>
      <li><a href="#mozTocId443357">Manipulating models: operators </a></li>
      <li><a href="#mozTocId604963">Optimising the iFunc model
          parameters</a></li>
      <li><a href="#mozTocId443357">Fitting model parameters onto data </a></li>
    </ul>
    <br>
    <hr style="width: 100%; height: 2px;">
    <div style="text-align: center;">Commands we use in this page: <span
        style="font-style: italic;">iFunc, save(iFunc, filename), fits<br>
      </span><span style="font-style: italic;"><b>See also</b>: <a
          href="Load.html">Load (import) data sets </a></span><span
        style="font-style: italic;"><span style="font-style: italic;"><a
            href="Loaders.html">Low level Loaders</a>,</span> <a
          href="Save.html">Save (export) data sets</a> </span><br>
    </div>
    <br>
    The <span style="font-style: italic;">iFunc</span> class is a
    structure which holds a multi-parameter model,to be used for e.g.
    plot or fit onto a data set. Models can be assembled using standard
    Matlab operators. There exist a set of pre-defined <a
      href="Models.html">Models</a>, which you can assemble to define
    more complex ones. You can also <a href="Fit.html">Fit</a> an iFunc
    model onto an <a href="iData.html">iData</a> object (containing
    e.g. some experimental data). The iFunc Models also exist in a set
    of specialized flavours (sub-classes) which inherit full <i>iFunc</i>
    capabilities, and add a few more specialized functionalities:<br>
    <ul>
      <li><a href="McStas.html">iFunc_McCode</a>: an instrument
        simulation model using e.g. <a href="McStas.html">McStas</a>.</li>
      <li><a href="iFunc_Sqw4D.html">iFunc_Sqw4D</a>: a 4D Model holding
        an S(<b>q</b>,w) from e.g. <a href="Models_Phonons.html">phonons</a>,
        <a href="Models.html#mozTocId908192">spinwaves</a>, etc.</li>
    </ul>
    <br>
    <h3 style="text-align: center;"><a class="mozTocH3"
        name="mozTocId466436"></a>Creating and inquiring iFunc models
      (iFunc, get, plot, subplot)<br>
    </h3>
    <span style="font-weight: bold;"></span>A model object holds an
    Expression (to compute the model value), a list of parameter names,
    a Guess expression to compute parameter value estimates, as well as
    other MetaData just as for <a href="iData.html">iData</a> objects.<br>
    <br>
    To create a model (i.e. instantiate a class into an object), specify
    its Expression, using<br>
    <ul>
      <li><span style="font-weight: bold;">x,y,z,t,u,v,w:</span> axes of
        ranks 1,2, 3, 4... The 1st axis rank corresponds with rows, 2nd
        for columns, ...</li>
      <li><span style="font-weight: bold;">p</span>: parameter values
        e.g. p(1), p(2), ...</li>
      <li><span style="font-weight: bold;">signal: </span>the model
        value when the Expression contains more than one statement.<br>
      </li>
    </ul>
    For instance a linear model is obtained with<br>
    <pre style="margin-left: 40px;">&gt;&gt; a=<span style="color: rgb(51, 102, 255);">iFunc</span>(<span style="color: rgb(204, 51, 204);">'p(1)*x+p(2)'</span>)
<br>a =  iFunc 1D model:<br><br>    [Tag] [Dim]                                [Model] [Parameters 'p']<br> iF193482   1        p(1)*x+p(2)  signal = p(1)*x+p(.. Amplitude Constant <br><br>&gt;&gt; a=<span style="color: rgb(51, 102, 255);">iFunc</span>(<span style="color: rgb(204, 51, 204);">'a=p(1); b=p(2); signal=a*x+b'</span>);	<span style="font-style: italic;">% same as above</span><br></pre>
    Any expression can be entered, and an analysis of the parameters
    results in default parameter names. <br>
    <br><h4><a name="mozTocId721898" class="mozTocH4"></a>Model from a tabulated data set</h4>
    It is also possible to create a model out of an <a href="iData.html">iData</a> (data set) object. Then, the model
    parameters are the total intensity scaling, as well as an offset and
    a scaling factor per axis. In order to create a model from a data
    file, use:<br>
    <pre>	&gt;&gt; <font color="#3366ff">iFunc</font>(<font color="#3366ff">iData</font>(<font color="#cc33cc">'filename'</font>))</pre>
    will create a data set object and derive a model out of it.<br>
    <br>
    You can then display the full content of the object with the <span style="color: rgb(51, 102, 255);">disp</span> or <span style="color: rgb(51, 102, 255);">get</span> methods :<br>
    <pre style="margin-left: 40px;">&gt;&gt; <span style="color: rgb(51, 102, 255);">disp</span>(a)<a href="images/iFunc_plot.png"><img alt="iFunc: plot" title="iFunc: plot" src="images/iFunc_plot.png" style="border: 0px solid; border: 0px solid; width: 300px; height: 267px;" align="right"></a><br>a = iFunc 1D model:<br>         <span style="font-weight: bold;">Expression: </span>signal = p(1)*x+p(2);<br>                Tag: 'iF193482'<br>               Date: '17-Jul-2012 10:49:50'<br>               Name: ' p(1)*x+p(2)'<br>         <span style="font-weight: bold;">Parameters: </span>{'Amplitude'  'Constant'}<br>          Dimension: 1<br>    ParameterValues: []<br>           UserData: ''<br><br>Parameters:<br>  p(  1)=           Amplitude<br>  p(  2)=            Constant<br><br>&gt;&gt; <span style="color: rgb(51, 102, 255);">plot</span>(a)<br></pre>
    A graphical representation of the model is obtained using the <span style="color: rgb(51, 102, 255);">plot</span> method. <br>
    <br>
    Properties of the model can be obtained with the <span style="color: rgb(51, 102, 255);">get</span> method, or with
    direct indexing :<br>
    <pre style="margin-left: 40px;">&gt;&gt; <span style="color: rgb(51, 102, 255);">get</span>(a, <span style="color: rgb(204, 51, 204);">'Expression'</span>)<br>&gt;&gt; a.Expression<br>ans =<br><br>signal = p(1)*x+p(2);<br><span style="color: rgb(51, 102, 255);"></span></pre>
    The <span style="font-weight: bold;">Expression</span> can be a
    character string returning the<span style="font-style: italic;">
      'signal' </span>as a function of the parameters<span style="font-style: italic;"> 'p' </span>and axes <span style="font-style: italic;">x,y,z,t,u,v,w</span><br>
    It can also be given as a function handle <span style="font-style:
      italic;">signal=@Expression(p, x,y, ...)</span>, which usually
    makes the model evaluation much faster.<br>
    <pre style="margin-left: 40px;">&gt;&gt; <span style="color: rgb(51, 102, 255);"><font color="#000000">a=</font>iFunc<font color="#000000">(<i>@(p,x)</i>p(1)*x+p(2))</font></span></pre>
    Additional arguments (above the model dimensionality) are usable in
    the Expression as<span style="font-style: italic;"> 'varargin' </span>cell.














    <br>
    The name of the parameters can be changed by accessing the <span style="font-weight: bold;">Parameters</span> property (this is a
    cell of strings) :<br>
    <pre style="margin-left: 40px;">&gt;&gt; <span style="color: rgb(51, 102, 255);"></span>a.Parameters = {<span style="color: rgb(204, 51, 204);">'Slope','Constant'</span>}<br></pre>
    The <span style="font-weight: bold;">ParameterValues</span>
    property holds the last parameter values (e.g. when returned from a
    fit or a function evaluation).<br>
    The <span style="font-weight: bold;">Guess</span> property should
    return a vector of parameter values<span style="font-style: italic;">
      'p' </span>as a function of the axes <span style="font-style:
      italic;">x,y,z...</span> and a <span style="font-style: italic;">signal.














    </span>This is a character string, vector or a function handle <span style="font-style: italic;">p=@Guess(x,y,z, ..., signal)</span>.
    Values of the parameters left as <span style="font-style: italic;">NaN</span>
    indicate that the automatic guess procedure should be used (which is
    based upon a signal peak search, and baseline analysis). The Guess
    is used when starting a fit procedure for starting parameters.<br>
    Last, the <span style="font-weight: bold;">Constraint</span>
    property holds any script to change the parameter values (character
    string modifying <span style="font-style: italic;">'p'</span>) from
    axes<span style="font-style: italic;"> x,y,z,...</span> or a
    function handle <span style="font-style: italic;">p=@Constraint(p,
      x,y,...)</span>. See <a href="#mozTocId579374">below</a> on how
    to define Constraints.<br>
    <br>
    To print out the <i>equivalent function</i> <i>f(p, x, ...)</i>
    from an object, convert it to a <i>char</i> or <i>cellstr</i>:<br>
    <pre style="margin-left: 40px;">&gt;&gt; a=<span style="color: rgb(51, 102, 255);">iFunc</span>(<span style="color: rgb(204, 51, 204);">'p(1)*x+p(2)'</span>)<br>&gt;&gt; char(a)<br>&gt;&gt; cellstr(a)<br></pre>
    Last, it is possible to define an empty iFunc object, and fill it
    with Parameters and any Expression, even without actually any
    mathematical model:<br>
    <pre style="margin-left: 40px;">&gt;&gt; a=<span style="color: rgb(51, 102, 255);">iFunc</span>;<br>&gt;&gt; a.Parameters={<font color="#cc33cc">'Amplitude'</font>,<font color="#cc33cc">'Width'</font>}<br>&gt;&gt; a.Expression=[ <font color="#cc33cc">'[ varargin{:} ]'</font> ];<br></pre>
    This way, it is possible to define any Matlab function inside an
    iFunc object. The cell 'varargin' then contains the arguments 2-end,
    while 'p' contains the first argument.<br>
    <pre style="margin-left: 40px;">&gt;&gt; a(1,2,3)<br>ans =<br>     2     3<br><br></pre>
    <h4><a class="mozTocH4" name="mozTocId780038"></a> Accessing or
      modifying parameter values</h4>
    <p>Parameters from a model can be accessed in many equivalent ways.
      If <span style="font-style: italic;">'a'</span> is an iFunc model
      :<br>
    </p>
    <pre style="margin-left: 40px;">&gt;&gt; <span style="color: rgb(51, 102, 255);"></span>a.Parameters		<span style="font-style: italic;">% lists all parameter names</span><br>&gt;&gt; <span style="color: rgb(51, 102, 255);">get</span>(a)		<span style="font-style: italic;">% display the model description, with the list of parameter names and last evaluated values</span><br>&gt;&gt; a.p			<span style="font-style: italic;">% returns a vector of parameter values</span><br>&gt;&gt; a.ParameterValues	<span style="font-style: italic;">% same as above, last evaluated parameter values</span><br></pre>
    <p>If, for instance, the model has an<span style="font-style:
        italic;"> 'Slope' </span>parameter, you can get specifically
      its value with :<br>
    </p>
    <pre style="margin-left: 40px;">&gt;&gt; <span style="color: rgb(51, 102, 255);"></span>a.Slope		<span style="font-style: italic;">% display the value of the 'Slope' parameter</span></pre>
    <p>Alternatively, it is possible to modify parameter values :<br>
    </p>
    <pre style="margin-left: 40px;">&gt;&gt; a.p(1) = 2;<br>&gt;&gt; a.Slope = 2;<br></pre>
    <h4><a class="mozTocH4" name="mozTocId354273"></a> <span style="font-weight: bold;">Defining a new model</span></h4>
    <span style="font-weight: bold;">To define a new model</span> with a
    dialogue window, use:<br>
    <pre style="margin-left: 40px;">&gt;&gt; <span style="color: rgb(51, 102, 255);">edit</span>(iFunc) <span style="font-style: italic;"></span></pre>
    <a href="images/iFunc_subplot.png"><img alt="iFunc: subplot" title="iFunc: subplot" src="images/iFunc_subplot.png" style="border: 0px solid; width: 200px; height: 304px;" align="right"></a>Refer to the dedicated help on this topic in
    the <a href="Models.html">Models</a> page, which also lists
    pre-defined models (Gaussian, Lorentzian, exponential, lines,
    quadratic, ...). Edit their code to see how to define new models:<br>
    <pre style="margin-left: 40px;">&gt;&gt; <span style="color: rgb(51, 102, 255);">edit</span> gauss <span style="font-style: italic;">% edit the function definition (from a file)</span><br>&gt;&gt; <span style="color: rgb(51, 102, 255);">edit</span> voigt<br>&gt;&gt; <span style="color: rgb(51, 102, 255);">edit</span>(voig) <span style="font-style: italic;">% edit the object definition</span></pre>
    When no parameter value is known, some guessed values are estimated
    from the analysis of the model value and expression.<br>
    <br>
    The <span style="color: rgb(51, 102, 255);">plot</span> method
    demonstrated above can display a set of models in a single axis
    frame, or a set of panels (<span style="color: rgb(51, 102, 255);">subplot</span>)
    :<br>
    <pre style="margin-left: 40px;">&gt;&gt; <span style="color: rgb(51, 102, 255);">plot</span>([gauss lorz])<br>&gt;&gt; <span style="color: rgb(51, 102, 255);">subplot</span>([gauss sine<span style="color: rgb(255, 0, 0);">.*</span>expon])	<span style="font-style: italic;">% use unary and binary operators, see below</span><br></pre>
    <h3 style="text-align: center;"><a class="mozTocH3" name="mozTocId966568"></a> Evaluating a model with parameter
      values and axes</h3>
    The syntax for evaluating a model is<br>
    <br>
    <div style="margin-left: 40px;"><br>
      <span style="font-weight: bold; font-style: italic;"><span style="font-weight: bold; font-style: italic;">model(parameters)&nbsp;&nbsp;&nbsp;


          &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp;
          &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; % use
          guessed axes</span><br>
        <br>
        model(parameters, x,y, ...)</span>&nbsp;&nbsp;&nbsp;
      &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; <i><b>%
          use given axes</b></i><br>
      <br>
      <span style="font-weight: bold; font-style: italic;">feval(model,
        parameters, x,y,z, ...)</span><br>
      <br>
      <i><b>iData(model, </b></i><i><b>parameters, x,y,z,
          ...)&nbsp;&nbsp;&nbsp; % evaluate and convert into an iData
          object</b></i> </div>
    <br>
    where parameters can be a numerical vector, or a structure with
    named parameters matching the model ones, <i>x,y,z,t,u,v,w</i> are
    axes values for ranks 1,2,3... Additional arguments (above the model
    dimensionality) are usable in the Expression as<span style="font-style: italic;"> 'varargin' </span>cell. <br>
    <br>
    When the parameters are specified as empty ( [] ), current parameter
    values are used, or guessed. These parameters can also be given as a
    vector corresponding to the model parameter order, a string such as
    <font color="#cc33cc">'Intensity=1; Width=.5'</font>, a structure
    with named fields and values such as:<br>
    <ul>
      <li>p.Intensity=1;</li>
      <li>p.Width=0.5;</li>
      <li>model(p)</li>
    </ul>
    The evaluation of a model with a set of parameters is obtained by
    calling the <span style="color: rgb(51, 102, 255);">feval</span>
    function with the parameter values, or sending these values directly
    to the object :<br>
    <pre style="margin-left: 40px;">&gt;&gt; signal = <span style="color: rgb(51, 102, 255);">feval</span>(gauss, [ 1 0 .1 0])<br>&gt;&gt; gauss([ 1 0 .1 0])		<span style="font-style: italic;">	% same as above: evaluate model</span>
</pre>
    In this case, tentative axes are computed from the model definition.
    Axes can also be passed as additional arguments for <span style="font-style: italic;">x,y,z,...</span> either as separate
    arguments, as a cell array {x,y,...}, as a structure, or as an <a href="iData.html">iData</a> object which axes are used.<br>
    <pre style="margin-left: 40px;">&gt;&gt; <span style="color: rgb(51, 102, 255);">feval</span>(gauss, [ 1 0 .1 0], <span style="color: rgb(51, 102, 255);">linspace</span>(-5,5, 100) )
&gt;&gt; gauss([ 1 0 .1 0], <span style="color: rgb(51, 102, 255);">linspace</span>(-5,5, 100) )		<span style="font-style: italic;">% same as above: evaluate model</span><br></pre>
    When used together with <a href="iData.html">iData</a> objects, the
    iFunc models can either return their evaluation (array), or be
    converted into an iData object for easier further handling.<br>
    <pre style="margin-left: 40px;">&gt;&gt; <b>iD</b> = iData(<span style="color: rgb(51, 102, 255);">linspace</span>(-5,5, 100), <font color="#3366ff">zeros</font>(1,100));	<i>% define a zero iData object with some axes</i><br>&gt;&gt; g  = gauss; 						% a Gaussian model<br>&gt;&gt; g([ 1 0 .1 0], <b>iD</b>)					<i>% evaluate model with axes in the iData object</i><br>&gt;&gt; <b>iD</b>(g, [1 0 .1 0])					<i>% evaluate model into a new iData object</i><br></pre>
    A faster calling syntax for the same result is:<br>
    <pre style="margin-left: 40px;">&gt;&gt; g=<font color="#3366ff">gauss</font>;<br>&gt;&gt; <font color="#3366ff">iData</font>(g, [1 0 .1 0], <span style="color: rgb(51, 102, 255);">linspace</span>(-5,5, 100), <font color="#3366ff">zeros</font>(1,100))	<i>% evaluate model into a new iData object<br></i></pre>
    It is also possible to evaluate the model while <b>scanning
      parameters</b>. To achieve that, the parameter values must be
    given as a named structure, or as a string such as <font color="#cc33cc">'Intensity=[ .5 1 1.5 2 ];'</font> <br>
    <br>
    For instance, to scan the <i>Intensity</i> parameter in a Gaussian,
    and get the model value as an array of data sets, use:<br>
    <ul>
      <li>
        <pre>model = <font color="#3366ff">gauss1</font>;</pre>
      </li>
      <li>
        <pre>p.Intensity= [ .5:.25:2 ];	<i>% from 0.5 to 2 by steps of .25</i></pre>
      </li>
      <li>
        <pre>v=<font color="#3366ff">iData</font>(model, p);	<i>% evaluate as iData sets. To only get the values, use feval(model,p)</i></pre>
      </li>
      <li>
        <pre><font color="#3366ff">plot</font>(<font color="#3366ff">cat</font>(2,v)); 	<i>% plot the scan as a surface</i></pre>
      </li>
    </ul>
    Scans with multiple parameters vectors can be performed the same
    way.<br>
    <h3 align="center"><a class="mozTocH3" name="mozTocId579374"></a>Setting





      and removing constraints on models</h3>
    Models are often used for fitting purposes (refer to the <a href="Fit.html">Fit</a> help page).<br>
    <br>
    To set a constraint on a model parameter, define the 'constraint'
    input argument when calling <span style="font-weight: bold;
      font-style: italic;">fits</span> (see <a href="Fit.html">Fit</a>)
    or set the constraint directly on the model parameters with:<br>
    <pre style="margin-left: 40px;">&gt;&gt; model.parameter=<span style="color: rgb(204, 51, 204);">'fix'</span>     <span style="font-style: italic;">% to lock its value during a fit process</span>. Same as mlock<br>&gt;&gt; model.parameter='<span style="color: rgb(204, 51, 204);">clear'</span>   <span style="font-style: italic;">% or <font color="#cc33cc">'free'</font> to unlock value during a fit process. Same as munlock</span>
&gt;&gt; model.parameter=[min max] <span style="font-style: italic;">% to bound value</span><br>&gt;&gt; model.parameter=[min value max] <span style="font-style: italic;">% to bound the parameter</span> and set its value<br>&gt;&gt; model.parameter=[nan nan] <span style="font-style: italic;">% to remove bound constraint</span><br>&gt;&gt; model.parameter=<span style="color: rgb(204, 51, 204);">''</span>        <span style="font-style: italic;">% to remove all constraints on 'parameter'</span><br>&gt;&gt; model.parameter=<span style="color: rgb(204, 51, 204);">'expression'</span>        <span style="font-style: italic;">% to set the parameter from an expression</span> which can use '<i>p(n)</i>' for other parameters<br>&gt;&gt; model.Constraint=<span style="color: rgb(204, 51, 204);">''</span>       <span style="font-style: italic;">% to remove all constraints</span><br>&gt;&gt; model.Constraint = 0;     <span style="font-style: italic;">% to unlock/free all Parameters during a fit process<br></span>&gt;&gt; model.Constraint = 1;     <span style="font-style: italic;">% to lock/fix all Parameters during a fit process</span><br></pre>
    Any parameter name surrounded by double quotes, e.g. <span style="font-style: italic;">"Amplitude"</span>, is replaced by the
    corresponding <span style="font-style: italic;">p(n)</span> value
    in an expression used for setting a parameter value
    (cross-constraints). For instance<br>
    <pre style="margin-left: 40px;">&gt;&gt; f=<span style="color: rgb(51, 102, 255);">gauss</span>;			<span style="font-style: italic;">% create a Gaussian model</span><br>&gt;&gt; f.Amplitude = <span style="color: rgb(204, 51, 204);">'fix'</span>;		<span style="font-style: italic;">% fix its Amplitude</span><br>&gt;&gt; f.Background = [0 1e-4];	<span style="font-style: italic;">% bound its background</span><br>&gt;&gt; f.Width = <span style="color: rgb(204, 51, 204);">'p(1)/1000'</span>;	<span style="font-style: italic;">% use an expression referring to </span>p(1)=Amplitude<span style="font-style: italic;"> value</span><br>&gt;&gt; f.Width = <span style="color: rgb(204, 51, 204);">'"Amplitude"/1000'</span>;	<span style="font-style: italic;">% same as above with direct naming of parameters using ""</span><br></pre>
    Alternatively, you can use the <span style="font-weight: bold;">mlock,














      munlock </span>and <span style="font-weight: bold;">xlim</span>
    methods:<br>
    <pre style="margin-left: 40px;">&gt;&gt; <span style="color: rgb(51, 102, 255);">mlock</span>(f, {<span style="color: rgb(204, 51, 204);">'Amplitude','Background'</span>})	<span style="font-style: italic;">% fix these 2 parameters</span>, same as setting parameters to 'fix' <br>&gt;&gt; <span style="color: rgb(51, 102, 255);">munlock</span>(f, <span style="color: rgb(204, 51, 204);">'Background'</span>)		<span style="font-style: italic;">% unlock that parameter</span>, same as f.Background='clear'<br>&gt;&gt; <span style="color: rgb(51, 102, 255);">xlim</span>(f, <span style="color: rgb(204, 51, 204);">   'Background'</span>, [0 1e-3])	<span style="font-style: italic;">% force parameter within range</span>, same as f.Background=[min max]<br>&gt;&gt; <span style="color: rgb(51, 102, 255);">xlim</span>(f,  <span style="color: rgb(204, 51, 204);">  'Background'</span>, [])		<span style="font-style: italic;">% remove limits constraint</span><br></pre>
    Last, you can fix/clear/bound parameters based on a <a href="http://en.wikipedia.org/wiki/Regular_expression">regular
      expression</a> search such as:<br>
    <pre style="margin-left: 40px;">&gt;&gt; <span style="color: rgb(51, 102, 255);">mlock</span>(f, <span style="color: rgb(51, 102, 255);">regexp</span>(f.Parameters, <span style="color: rgb(204, 51, 204);">'Amplitude|Background'</span>})</pre>
    where we have used the '|' OR operator.<br>
    <br>
    To list parameters which are fixed, free and bound, use:<br>
    <pre style="margin-left: 40px;">&gt;&gt; <span style="color: rgb(51, 102, 255);">mlock</span>(f)<br>&gt;&gt; <span style="color: rgb(51, 102, 255);">munlock</span>(f)<br>&gt;&gt; <span style="color: rgb(51, 102, 255);">xlim</span>(f)</pre>
    which return the number of parameters in each category. This is also
    displayed when using:<br>
    <pre style="margin-left: 40px;">&gt;&gt; <span style="color: rgb(51, 102, 255);">disp</span>(f)</pre>
    Under the hood, the constraints are stored as a structure with
    fields <span style="font-style: italic;">min, max, fixed, set</span>
    (with one expression per parameter), and <span style="font-style:
      italic;">eval</span> (to be evaluated before the object
    Expression).<br>
    <br>
    <h3 style="text-align: center;"><a class="mozTocH3" name="mozTocId2492"></a>Saving objects for further re-use: save,
      saveas, load<br></h3>
    <p>Once you have created an manipulated a model, it is possible to
      export it into a file so that you can re-use it latter. To do so,
      use <span style="font-style: italic;">saveas(object, ...)</span>
      similarly as when <a href="Save.html">saving iData objects</a>. '<span style="font-style: italic;">save</span>' is equivalent to <span style="font-style: italic;">saveas</span>.<br>
    </p>
    <pre style="margin-left: 40px;">&gt;&gt; a=<span style="color: rgb(51, 102, 255);">iFunc</span>(<span style="color: rgb(204, 51, 204);">'p(1)*x+p(2)'</span>) + gauss ;<br>&gt;&gt; <span style="color: rgb(51, 102, 255);">saveas</span>(a);			<span style="font-style: italic;">% save as a Matlab m-file function</span>, file name is automatically set to the model iD<br>&gt;&gt; <span style="color: rgb(51, 102, 255);">saveas</span>(a,<span style="color: rgb(204, 51, 204);"> ''</span>, <span style="color: rgb(204, 51, 204);">'mat'</span>)		<span style="font-style: italic;">% same, with a 'mat' file</span><br>&gt;&gt; <span style="color: rgb(51, 102, 255);">save</span>(a,<span style="color: rgb(204, 51, 204);"> 'model.</span><span style="color: rgb(204, 51, 204);">mat'</span>)	<span style="font-style: italic;">% same, with a 'mat' file, specifying the file name</span>
</pre>
    <p>The supported export formats are [ as listed with <span style="font-style: italic;"><span style="color: rgb(51, 102,
          255);">saveas</span>(iFunc,<span style="color: rgb(204, 51,
          204);">'formats'</span>)</span> ]:<br>
    </p>
    <pre style="margin-left: 40px;">       DAT  Flat text file with comments (*.dat) <br>       EPS  Encapsulated PostScript (color, *.eps) <br>       FIG  Matlab figure (*.fig) <br>   HDF4;H4  Hierarchical Data Format 4 image (*.hdf4) <br>  HTML;HTM  Hypertext Markup Language document (*.html) <br>       JPG  JPEG image (*.jpg) <br>      JSON  JSON JavaScript Object Notation (*.json) <br>         M  Matlab script/function (*.m) <br>       MAT  Matlab binary file (*.mat) <br>       PDF  Portable Document Format (*.pdf) <br>       PNG  Portable Network Graphics image (*.png) <br>        PS  PostScript (color, *.ps) <br>  TIFF;TIF  TIFF image (*.tif) <br>       XML  XML file (*.xml) <br>  YAML;YML  YAML interchange format (*.yaml) <br></pre>
    <p>We recommend to save iFunc models as MAT files, or m-files or
      YAML.</p>
    <p> To load back an <span style="font-style: italic;">m</span> or <span style="font-style: italic;">mat</span> file into memory for
      re-use:<br></p><ul><li>type the m-file name without extension, </li><li>or '<span style="font-style: italic;">load filename.mat</span>' for
      MAT-files, </li><li>or<i> 'iFunc(filename)'</i> for other formats (supports JSON, YAML, M, MAT, XML).</li></ul>
    <span style="font-weight: bold;"></span>
    <h3 style="text-align: center;"><a class="mozTocH3" name="mozTocId443357"></a>Manipulating models: operators<br>
    </h3>
    Models can be assembled to create more complex models. This is
    achieved simply with <span style="font-weight: bold;">unary</span>
    and <span style="font-weight: bold;">binary</span> operators:<br>
    <br>
    <table style=" text-align: left; width: 100%;" border="1" cellpadding="2" cellspacing="2">
      <tbody>
        <tr>
          <td style="vertical-align: top; font-weight: bold;">Unary
            operators<br>
          </td>
          <td style="vertical-align: top;">abs char del2 floor sparse
            transpose&nbsp; acos conj full sqrt uminus&nbsp; acosh
            real&nbsp; asin exp ndims round xcorr&nbsp; asinh imag
            norm&nbsp; atan cos isempty not sign tan&nbsp; atanh cosh
            fliplr log sin tanh&nbsp; ceil ctranspose flipud log10
            plus(+) sinh minus(-)<br>
          </td>
        </tr>
        <tr>
          <td style="vertical-align: top; font-weight: bold;">Binary
            operators<br>
          </td>
          <td style="vertical-align: top;">mtimes(*) times (.*)
            mpower(^) power(.^) mrdivide(/) rdivide(./) conv convn<br>
          </td>
        </tr>
        <tr>
          <td style="vertical-align: top;"><span style="font-weight:
              bold;">Other operators</span><br>
          </td>
          <td style="vertical-align: top;">edit plot char copyobj doc
            feval fits get set subplot conv convn xcorr save saveas<br>
          </td>
        </tr>
      </tbody>
    </table>
    <br>
    The full list of operators can be obtained from the <br>
    <pre style="margin-left: 40px;">&gt;&gt; <span style="color: rgb(51, 102, 255);">methods</span> iFunc</pre>
    The element-wise times(.*), divide(./) and power(.^) operators apply
    the operation along the model dimensions, with parallel axes.&nbsp;
    <br>
    The matrix-operators mtimes(*), <a href="images/iFunc_operators.png"><img alt="iFunc: + .* and *
        operators" title="iFunc: + .* and * operators" src="images/iFunc_operators.png" style="border: 0px solid;
        width: 200px; height: 279px;" align="right"></a>mrdivide(/) and
    mpower(^) operator perform <span style="font-style: italic;"><span style="font-weight: bold;">orthogonal</span> axes multiplication</span>,
    with extension of the model dimensionality. <br>
    <br>
    Examples are easier to understand, so let's see a few operations :<br>
    <pre style="margin-left: 40px;">&gt;&gt; a = gauss  + lorz;		<span style="font-style: italic;">% addition</span><br>&gt;&gt; b = gauss  * lorz; 		<span style="font-style: italic;">% <span style="font-weight: bold;">orthogonal</span> axes multiplication 2x 1D -&gt; 2D</span><br>&gt;&gt; c = gauss .* lorz; 		<span style="font-style: italic;">% parallel axes multiplication</span><br>&gt;&gt; c.Constraint = <span style="color: rgb(204, 51, 204);">'p(8) = 0;'</span>;	% avoid having two Background parameters<br>&gt;&gt; <span style="color: rgb(51, 102, 255);">subplot</span>([a b c])<br></pre>
    In binary operations, passing one of the arguments as a <span style="font-weight: bold;">string</span> will simply insert the
    corresponding code into the model Expression as the argument to the
    operator. For instance the following statement appends a zero value
    vector to the <span style="font-style: italic;">gauss</span> model
    value (axes are <span style="font-style: italic;">x,y,z</span>,...
    and parameters values are in <span style="font-style: italic;">p</span>):<br>
    <div style="margin-left: 40px;">
      <pre>&gt;&gt; c = gauss + <span style="color: rgb(204, 51, 204);">'zeros(size(x))'</span></pre>
    </div>
    The addition operator <span style="font-style: italic;">plus (+)</span>
    used with a string argument which contains an equal sign<span style="color: rgb(255, 0, 0);"> </span><span style="font-weight:
      bold; color: rgb(255, 0, 0);">'='</span> or<span style="color:
      rgb(255, 0, 0);"> </span><span style="font-weight: bold; color:
      rgb(255, 0, 0);">';'</span><span style="color: rgb(255, 0, 0);"> </span>character















    concatenates the string before/after the Expression of the model. For
    instance the following example does the same as above, explicitly
    setting the new signal value, and the next one displays a text
    before evaluating the model :<br>
    <pre style="margin-left: 40px;">&gt;&gt; c = gauss + <span style="color: rgb(204, 51, 204);">'signal = signal + zeros(size(x));'<span style="color: rgb(0, 0, 0);">;	<span style="font-style: italic;">% add code after the Expression (append)<br></span></span></span>&gt;&gt; c = <span style="color: rgb(204, 51, 204);">'disp(''Gaussian comming'');'<span style="color: rgb(0, 0, 0);">+ gauss;		<span style="font-style: italic;">% add code before the Expression</span></span></span><span style="font-style: italic;"> (prepend)</span><br></pre>
    Last, when using a single word character string as one of the
    arguments to a binary operation, a constant Parameter is used, for
    instance :<br>
    <pre style="margin-left: 40px;">&gt;&gt; c = gauss + <span style="color: rgb(204, 51, 204);">'Background'		</span><span style="color: rgb(204, 51, 204);"><span style="color: rgb(0, 0, 0);"><span style="font-style: italic;">	% add a new Background parameter<br></span></span></span>&gt;&gt; c = gauss + constant(<span style="color: rgb(204, 51, 204);">'Background'</span>)	<span style="font-style: italic;">	% same as above</span><br>&gt;&gt; c = gauss + constant				<span style="font-style: italic;">% same as above, but not naming explicitly the new Constant</span>
&gt;&gt; d = gauss.*<span style="color: rgb(204, 51, 204);">'Amplitude'</span> + <span style="color: rgb(204, 51, 204);">'Background'</span>	<span style="font-style: italic;">% add 2 new constant Parameters</span>
</pre>
    You can also use the convolution related operators<br>
    <ul>
      <li><span style="font-weight: bold;">conv: </span>convolution</li>
      <li><span style="font-weight: bold;">convn: </span>normalized
        convolution (which normalizes and centers the 2nd argument)<br>
      </li>
      <li><span style="font-weight: bold;">xcorr: </span>cross-correlation</li>
    </ul>
    In these methods, when one of the argument is scalar, a Gaussian
    function of that width is built for convolution/correlation.<br>
    <pre style="margin-left: 40px;">&gt;&gt; a = <span style="color: rgb(51, 102, 255);">convn</span>(lorz, 3)		<span style="font-style: italic;">% convolution of a Lorentzian with a Gaussian of width 3<br></span>&gt;&gt; a = <span style="color: rgb(51, 102, 255);">convn</span>(lorz, gauss)	<span style="font-style: italic;">% a Voigt function...<br></span>&gt;&gt; a = <span style="color: rgb(51, 102, 255);">convn</span>(lorz, <span style="color: rgb(204, 51, 204);">'double(b)'</span>)<span style="font-style: italic;">; </span>a.Constraint = <span style="color: rgb(204, 51, 204);">'global b'</span>;	% convolute with a global variable 'b'<br></pre>
    Methods generally mimic the Matlab default ones in functionality,
    and are also similar to those of the <a href="iData.html">iData</a>
    objects (see the <a href="Methods.html">Methods</a> page).<br><br>It is possible to apply binary operators on mixed type arguments (e.g. a Data set and a Model), in which case the result depends on the arguments, as detailed in the '<a href="iData.html#mozTocId57469">binary operators with mixed arguments</a>' help.<br>
    <br>
    <h3 align="center"><a class="mozTocH3" name="mozTocId604963"></a>Optimising



      the iFunc model parameters</h3>
    It is possible to optimize the model parameter values in order to
    minimize or maximize the model value, with the '<b>fmin</b>' method.
    For this, any optimizer can be used, e.g.<br>
    <pre style="margin-left: 40px;">&gt;&gt; p = <span style="color: rgb(51, 102, 255);">fmin</span>(model)
</pre>
    will use some guessed axes and automatic optimizer choice for the
    optimisation. To start the optimization for a given initial
    parameter set, use:<br>
    <pre style="margin-left: 40px;">&gt;&gt; p = <span style="color: rgb(51, 102, 255);">fmin</span>(model, starting_pars)</pre>
    The starting parameters can be given as a vector, structure or
    string such as <font color="#cc33cc">'Intensity=1'</font> as
    explained <a href="mozTocId966568">above</a>.<br>
    When given as a structure or a string, the resulting optimised
    parameters are returned as a structure.<br>
    <br>
    You may also set manually the optimizer configuration and axes to
    use with:<br>
    <pre style="margin-left: 40px;">&gt;&gt; p = <span style="color: rgb(51, 102, 255);">fmin</span>(model, starting_pars, options, x,y, ...)</pre>
    Just as detailed in the <a href="Optimizers.html">Optimizers</a>
    documentation, you may specify the 'options' as the name of the
    optimizer (then using its default configuration), a string, or a
    structure, such as in the following examples:<br>
    <pre style="margin-left: 40px;">&gt;&gt; p = <span style="color: rgb(51, 102, 255);">fmin</span>(model, starting_pars, <font color="#cc33cc">'fminpso'</font>)<br>&gt;&gt; p = <span style="color: rgb(51, 102, 255);">fmin</span>(model, starting_pars, <font color="#cc33cc">'optimizer=fminpso; OutputFcn=fminplot; Display=iter'</font>)<br></pre>
    By default, the axes to use for the evaluation will be guessed. In
    order to explicitly specify the axes to use, add them after the
    options:<br>
    <pre style="margin-left: 40px;">&gt;&gt; p = <span style="color: rgb(51, 102, 255);">fmin</span>(model, starting_pars, <font color="#cc33cc">'optimizer=fminpso; OutputFcn=fminplot; Display=iter'</font>, x,y, ...)</pre>
    In all cases, it is <font color="#ff0000">strongly advised</font>
    to fix the non-relevant parameters, and bound the others, as
    explained <a href="#mozTocId579374">above</a>.<br>
    For instance:<br>
    <pre style="margin-left: 40px;">&gt;&gt; model= <font color="#3366ff">gauss1</font>;<br>&gt;&gt; <font color="#3366ff">fix</font>(model, <font color="#cc33cc">'all'</font>); model.Intensity=<font color="#cc33cc">'free'</font>;<br>&gt;&gt; model.Intensity=1; model.HalfWidth=.5;<br>&gt;&gt; <font color="#3366ff">xlim</font>(model, <font color="#cc33cc">'Intensity'</font>,[-2 2])<br>&gt;&gt; <font color="#3366ff">fmin</font>(model)<br>ans =<br>   -2.0000         0    0.5000<br>&gt;&gt; <font color="#3366ff">fmin</font>(model, <font color="#cc33cc">'Intensity=1'</font>)<br>ans = <br>    Intensity: -2<br></pre>
    will search for the intensity that minimizes a Gaussian. This is of
    course the lower Intensity bound, other parameters being fixed.<br>
    <br>
    It is also possible to maximize the model parameters with the
    similar '<b>fmax</b>' method. The result is then the upper Intensity
    bound.<br>
    <pre style="margin-left: 40px;">&gt;&gt; model= <font color="#3366ff">gauss1</font>;<br>&gt;&gt; <font color="#3366ff">fix</font>(model, <font color="#cc33cc">'all'</font>); model.Intensity=<font color="#cc33cc">'free'</font>;<br>&gt;&gt; model.Intensity=1; model.HalfWidth=.5;<br>&gt;&gt; <font color="#3366ff">xlim</font>(model, <font color="#cc33cc">'Intensity'</font>,[-2 2])<br>&gt;&gt; <font color="#3366ff">fmax</font>(model)<br>ans =<br>    1.9995         0    0.5000<br></pre>
    <h3 style="text-align: center;"><a class="mozTocH3" name="mozTocId443357"></a>Fitting model parameters onto data<br>
    </h3>
    <div align="center"> <i><b>NOTE:</b> a more detailed documentation
        on this topic is available in the </i><i><a href="Fit.html">Fit</a></i><i>
        page.</i><br>
    </div>
    <br>
    Once models have been assembled, it is possible to use them for
    fitting, that is find the best parameter values to match a data set.
    The syntax for this is :<br>
    <pre style="margin-left: 40px;">&gt;&gt; p = <span style="color: rgb(51, 102, 255);">fits</span>(model, data, starting_parameters, options, constraints, ...)</pre>
    The data can be given as an <a href="iData.html">iData</a> object,
    a vector/matrix, <br>
    <div style="margin-left: 40px;"><span style="font-style: italic;">data=[














        .... ]</span><br>
    </div>
    a structure with members <br>
    <div style="margin-left: 40px;"><span style="font-style: italic;">data.Signal














      </span><br style="font-style: italic;">
      <span style="font-style: italic;">data.Error </span><br style="font-style: italic;">
      <span style="font-style: italic;">data.Monitor </span><br style="font-style: italic;">
      <span style="font-style: italic;">data.Axes={x,y,...}</span><br>
    </div>
    or a cell <br>
    <div style="margin-left: 40px;"><span style="font-style: italic;">data={














        x,y, ... , Signal }</span><br>
      <br>
    </div>
    Similarly to the <a href="iData.html">iData</a> objects, the 'x'
    1st rank axis corresponds to rows, 'y' to columns. When the data has
    a higher dimensionality as the model, this latter is extended by
    orthogonal multiplication to match the data dimensionality. It is
    thus possible for instance to fit a 4D data set with the default
    'gauss' model, which then results in the creation of the
    'gauss*gauss*gauss*gauss' model.<br>
    <br>
    The fit begins from the given starting values, or from guessed
    values if entered as empty. Other <span style="font-weight: bold;">options</span>
    and <span style="font-weight: bold;">constraints</span>, as well as
    returned arguments, are the same as described in the <a href="Fit.html">Fit</a> page. Empty input argument values request
    the fit to use default values.<br>
    <pre>	&gt;&gt; data=<font color="#3366ff">load</font>(iData, [ <font color="#3366ff">ifitpath</font> <font color="#cc33cc">'Data/sv1850.scn'</font> ])<br>	&gt;&gt; p=<font color="#3366ff">fits</font>(data);	% fit to a gaussian<br></pre>
    or with a specific optmiser choice:<br>
    <pre>	&gt;&gt; [p,c,m,o]=<font color="#3366ff">fits</font>(gauss,data,[],<font color="#cc33cc">'optimizer=fminpowell; OutputFcn=fminplot'</font>); </pre>
    The model value when the fit procedure ends is stored in the
    output.modelValue member :<br>
    <pre style="margin-left: 40px;">&gt;&gt; [parameters,criteria,message,<span style="color: rgb(255, 0, 0);">output</span>]= <span style="color: rgb(51, 102, 255);">fits</span>(<span style="color: rgb(204, 51, 204);">model,<span style="color: rgb(0, 0, 0);"> data, </span></span>initial_parameters,...)</pre>
    which is an <a href="iData.html">iData</a> object when <span style="font-style: italic;">data</span> is given as an iData. In
    this case, <span style="font-style: italic;">fits(iFunc, iData,
      ...)</span> is equivalent to <span style="font-style: italic;">fits(iData,

      iFunc, ...)</span>, and you can directly plot the result on top of
    the initial data with:<br>
    <pre style="margin-left: 40px;">&gt;&gt; <span style="color: rgb(51, 102, 255);">plot</span>(data, <span style="color: rgb(255, 0, 0);">output</span>.modelValue)</pre>
    When the data to be fitted is not an iData object, you can plot the
    fit result from e.g.<br>
    <blockquote>
      <pre>&gt;&gt; <font color="#3366ff">plot</font>(output.modelAxes,output.modelValue)	% 1D<br>&gt;&gt; <font color="#3366ff">surf</font>(output.modelAxes{:},output.modelValue)	% 2D
</pre>
    </blockquote>
    <br>
    <hr style="width: 100%; height: 2px;">
    <div style="text-align: center;"><span style="font-style: italic;">E.
Farhi














        - iFit/iFunc objects - $Date$ $Revision:1.7 $ </span> - back to
      <a href="index.html">Main iFit Page </a><a href="http://www.ill.eu/"><img title="ILL, Grenoble, France
          &lt;www.ill.eu&gt;" src="images/ILL-web-jpeg.jpg" alt="ILL,
          Grenoble, France &lt;www.ill.eu&gt;" style="border: 0px solid
          ; width: 53px; height: 50px;" align="right"></a> </div>
  


</body></html>